###############################################################################
# CI workflow — runs on every PR and push
#
# Spins up an ephemeral MySQL 8 service container, validates the changelog,
# applies all migrations, runs the demo pipeline, and verifies DQ checks.
# On migration failure: automatically restores the pre-migration backup.
###############################################################################
name: CI

on:
  pull_request:
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: ci_root_pw
          MYSQL_DATABASE: migration_db
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -u root -pci_root_pw"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      DB_HOST: 127.0.0.1
      DB_PORT: "3306"
      DB_USER: root
      DB_PASSWORD: ci_root_pw
      DB_NAME: migration_db
      ENV_NAME: ci

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirements.txt

      # ---------- Migration: validate + plan --------------------------------
      - name: Validate changelog (offline)
        run: python -m src.migrate validate

      - name: Show pending changesets
        run: python -m src.migrate status

      - name: Dry-run — print SQL that would execute
        run: python -m src.migrate update_sql

      # ---------- Migration: backup + apply + auto-rollback -----------------
      - name: Pre-migration backup
        run: |
          ts=$(date -u +%Y%m%dT%H%M%SZ)
          BACKUP_FILE="backup_ci_${ts}.sql"
          mysqldump -h 127.0.0.1 -P 3306 -u root -pci_root_pw \
            --routines --triggers --events --single-transaction \
            migration_db > "$BACKUP_FILE"
          echo "BACKUP_FILE=$BACKUP_FILE" >> $GITHUB_ENV

      - name: Apply migrations
        id: migrate
        run: python -m src.migrate update

      - name: Auto-rollback on migration failure
        if: failure() && steps.migrate.outcome == 'failure'
        run: |
          echo "::error::Migration failed — restoring from $BACKUP_FILE"
          mysql -h 127.0.0.1 -P 3306 -u root -pci_root_pw \
            migration_db < "$BACKUP_FILE"
          echo "Rollback to previous version complete."

      # ---------- Pipeline: ingest → transform → validate -------------------
      - name: Run data pipeline
        run: python -m src.pipeline run --env ci

      # ---------- Post-migration verification --------------------------------
      - name: Verify checksums
        run: python -m src.migrate verify

      # ---------- Artifacts --------------------------------------------------
      - name: Upload backup artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pre-migration-backup-ci
          path: backup_ci_*.sql
          retention-days: 7
