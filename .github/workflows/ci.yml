###############################################################################
# CI workflow ‚Äî runs on PRs for validation only
#
# Validates migration files format and syntax without executing them.
# No database operations - only static validation.
###############################################################################
name: CI Validation

on:
  pull_request:
    paths:
      - 'migrations/*.up.sql'

jobs:
  validate-migrations:
    name: Validate Migration Files
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: ci_test_pw
          MYSQL_DATABASE: migration_test_db
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -u root -pci_test_pw"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      DB_HOST: 127.0.0.1
      DB_PORT: 3306
      DB_USER: root
      DB_PASSWORD: ci_test_pw
      DB_NAME: migration_test_db
      ENV_NAME: ci

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Detect new migration files
        id: detect
        run: |
          echo "üîç Detecting new migration files in PR..."
          NEW_FILES=$(git diff --name-only --diff-filter=A origin/${{ github.base_ref }}...HEAD | grep "migrations/.*\.up\.sql" || true)
          
          if [ -n "$NEW_FILES" ]; then
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo "$NEW_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "has-new=true" >> $GITHUB_OUTPUT
            echo "üÜï New migration files detected:"
            echo "$NEW_FILES" | while read file; do
              echo "  - $file"
            done
          else
            echo "has-new=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No new migration files detected"
          fi

      - name: Validate SQL file format and headers
        if: steps.detect.outputs.has-new == 'true'
        run: |
          echo "üîç Validating SQL file format and required headers..."
          
          NEW_FILES="${{ steps.detect.outputs.files }}"
          
          for file in $NEW_FILES; do
            echo "Checking $file..."
            
            # Check filename format (XXX_description.up.sql)
            if [[ ! "$file" =~ migrations/[0-9]{3}_[a-zA-Z0-9_]+\.up\.sql$ ]]; then
              echo "‚ùå Invalid filename format: $file"
              echo "Expected format: migrations/XXX_description.up.sql"
              exit 1
            fi
            
            # Check required headers
            if ! grep -q "^-- id:" "$file"; then
              echo "‚ùå Missing required header '-- id:' in $file"
              exit 1
            fi
            
            if ! grep -q "^-- author:" "$file"; then
              echo "‚ùå Missing required header '-- author:' in $file"
              exit 1
            fi
            
            if ! grep -q "^-- risk:" "$file"; then
              echo "‚ùå Missing required header '-- risk:' in $file"
              exit 1
            fi
            
            # Extract and validate ID matches filename
            FILE_ID=$(basename "$file" | cut -d'_' -f1)
            HEADER_ID=$(grep "^-- id:" "$file" | sed 's/-- id: *//' | tr -d ' ')
            
            if [ "$FILE_ID" != "$HEADER_ID" ]; then
              echo "‚ùå ID mismatch in $file: filename has '$FILE_ID' but header has '$HEADER_ID'"
              exit 1
            fi
            
            # Check for basic SQL syntax issues
            if grep -q "DROP TABLE\|DROP DATABASE\|TRUNCATE" "$file"; then
              ALLOW_DESTRUCTIVE=$(grep "^-- allowDestructive:" "$file" | sed 's/-- allowDestructive: *//' | tr -d ' ')
              if [ "$ALLOW_DESTRUCTIVE" != "true" ]; then
                echo "‚ùå Destructive operation detected in $file but allowDestructive is not set to true"
                exit 1
              fi
            fi
            
            echo "‚úÖ $file format is valid"
          done
          
          echo "üéâ All SQL files are properly formatted!"

      - name: Offline validation (no database)
        run: |
          echo "üîç Running offline migration validation..."
          # This validates the changelog format without connecting to database
          python -c "
          from src.migrate.changelog import auto_generate_changelog
          try:
              changelog = auto_generate_changelog('migrations')
              print(f'‚úÖ Changelog validation passed - {len(changelog)} migrations found')
          except Exception as e:
              print(f'‚ùå Changelog validation failed: {e}')
              exit(1)
          "

      - name: Comment on PR with validation results
        if: steps.detect.outputs.has-new == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const newFiles = `${{ steps.detect.outputs.files }}`.split('\n').filter(f => f.trim());
            
            let comment = `## üîç Migration Validation Results\n\n`;
            comment += `### ‚úÖ Validation Status\n`;
            comment += `- **Format Validation**: ‚úÖ Passed\n`;
            comment += `- **Header Validation**: ‚úÖ Passed\n`;
            comment += `- **Offline Validation**: ‚úÖ Passed\n\n`;
            
            comment += `### üìÅ New Migration Files\n`;
            newFiles.forEach(file => {
              comment += `- \`${file}\`\n`;
            });
            
            comment += `\n### üéØ Next Steps\n`;
            comment += `1. **Review and approve this PR** to merge to main\n`;
            comment += `2. **Auto-deployment to dev** will trigger after merge\n`;
            comment += `3. **Manual production deployment** available after dev success\n\n`;
            
            comment += `### ‚ö†Ô∏è Important Notes\n`;
            comment += `- No database operations performed during validation\n`;
            comment += `- Actual migration testing happens in dev environment\n`;
            comment += `- Production deployment requires manual approval\n`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
