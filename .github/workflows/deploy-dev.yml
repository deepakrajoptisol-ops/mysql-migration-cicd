###############################################################################
# Dev deploy workflow — triggered on push to main
#
# Uses GitHub Environment "dev" for secret isolation.
# Takes a pre-migration backup, applies changesets, runs the pipeline,
# and auto-rolls-back on failure.
###############################################################################
name: Deploy Dev

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: dev

    # For demo: use a service container.
    # In production: remove the service block and point DB_HOST at
    # the real dev database via GitHub Environment secrets.
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: testpw
          MYSQL_DATABASE: migration_db_dev
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -u root -ptestpw"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      DB_HOST:     127.0.0.1
      DB_PORT:     3306
      DB_USER:     root
      ENV_NAME:    dev

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirements.txt

      # ---------- Backup -----------------------------------------------------
      - name: Pre-migration backup
        env:
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
        run: |
          ts=$(date -u +%Y%m%dT%H%M%SZ)
          BACKUP_FILE="backup_dev_${ts}.sql"
          mysqldump -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p"$DB_PASSWORD" \
            --routines --triggers --events --single-transaction \
            "$DB_NAME" > "$BACKUP_FILE"
          echo "BACKUP_FILE=$BACKUP_FILE" >> $GITHUB_ENV

      # ---------- Migrate ----------------------------------------------------
      - name: Apply migrations (dev context)
        id: migrate
        env:
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
        run: python -m src.migrate update --context dev

      - name: Auto-rollback on migration failure
        if: failure() && steps.migrate.outcome == 'failure'
        env:
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
        run: |
          echo "::error::Migration failed — restoring from $BACKUP_FILE"
          mysql -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p"$DB_PASSWORD" \
            "$DB_NAME" < "$BACKUP_FILE"
          echo "Rollback to previous version complete."

      # ---------- Pipeline ---------------------------------------------------
      - name: Run data pipeline (dev)
        env:
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
        run: python -m src.pipeline run --env dev

      # ---------- Artifacts --------------------------------------------------
      - name: Upload backup artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pre-migration-backup-dev
          path: backup_dev_*.sql
          retention-days: 30
